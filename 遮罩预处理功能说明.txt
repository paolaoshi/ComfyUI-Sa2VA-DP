╔══════════════════════════════════════════════════════════════╗
║                                                              ║
║          🎨 遮罩预处理功能说明                                ║
║                                                              ║
╚══════════════════════════════════════════════════════════════╝

更新日期: 2024-11-19

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✨ 更新内容
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. ❌ 移除8bit量化选项
   原因: Sa2VA模型与8bit量化不兼容，会导致运行时错误
   保留选项: None (FP16/BF16) 和 4bit (NF4)

2. ✅ 新增遮罩预处理功能
   参考KJNodes的遮罩模糊生长节点
   提供9个可调参数，灵活处理遮罩

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎨 遮罩预处理参数说明
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔘 启用遮罩预处理
  类型: 布尔值
  默认: false (关闭)
  说明: 主开关，只有开启后，下面的参数才会生效
        关闭时，所有预处理参数都无效

📏 扩展（像素）
  类型: 整数
  范围: -999 到 999
  默认: 0
  说明: 扩展或收缩遮罩边缘
        • 正值 → 膨胀（扩大遮罩）
        • 负值 → 腐蚀（缩小遮罩）
        • 0 → 不改变
  
  示例:
    • +10 → 遮罩向外扩展10像素
    • -5 → 遮罩向内收缩5像素

📐 扩展增量
  类型: 浮点数
  范围: 0.0 到 100.0
  默认: 0.0
  说明: 额外的扩展量，与"扩展"参数叠加
        用于微调扩展效果
  
  计算: 总扩展 = 扩展 + 扩展增量

🔲 倒角
  类型: 布尔值
  默认: true (开启)
  说明: 控制扩展/腐蚀时的形状
        • true → 使用椭圆形核（圆滑边缘）
        • false → 使用矩形核（方形边缘）
  
  效果:
    • 开启 → 边缘更自然、更圆滑
    • 关闭 → 边缘更锐利、更方正

🔄 反转输入
  类型: 布尔值
  默认: false (关闭)
  说明: 反转遮罩的黑白
        • true → 前景变背景，背景变前景
        • false → 保持原样
  
  用途:
    • 处理反向遮罩
    • 快速获得相反的选区

🌫️ 模糊半径
  类型: 浮点数
  范围: 0.0 到 100.0
  默认: 0.0
  说明: 高斯模糊的半径
        • 0 → 不模糊
        • 值越大 → 模糊越强
  
  效果:
    • 柔化遮罩边缘
    • 创建羽化效果
    • 减少锯齿

💫 线性透明
  类型: 浮点数
  范围: 0.0 到 1.0
  默认: 1.0
  说明: 处理后遮罩与原始遮罩的混合比例
        • 1.0 → 完全使用处理后的遮罩
        • 0.0 → 完全使用原始遮罩
        • 0.5 → 两者各占50%
  
  用途:
    • 减弱处理效果
    • 保留部分原始特征
    • 创建过渡效果

🎚️ 腐蚀系数
  类型: 浮点数
  范围: 0.0 到 1.0
  默认: 1.0
  说明: 控制遮罩内部的衰减程度
        • 1.0 → 不衰减
        • 0.0 → 最大衰减（只保留边缘）
  
  效果:
    • 创建从中心到边缘的渐变
    • 值越小，中心越暗
    • 可用于创建软边缘效果

🔳 填补
  类型: 布尔值
  默认: false (关闭)
  说明: 填补遮罩内部的孔洞
        • true → 填补所有孔洞
        • false → 保持孔洞
  
  用途:
    • 修复分割不完整的区域
    • 创建实心遮罩
    • 去除内部噪点

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 使用流程
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 基础使用
   ┌─────────────────────────────────┐
   │ 🎨启用遮罩预处理: false         │ ← 默认关闭
   │ 📏扩展: 0                       │
   │ 📐扩展增量: 0.0                 │
   │ ... (其他参数)                  │
   └─────────────────────────────────┘
   
   结果: 使用原始遮罩，不做任何处理

2. 启用预处理
   ┌─────────────────────────────────┐
   │ 🎨启用遮罩预处理: true          │ ← 开启
   │ 📏扩展: 10                      │ ← 扩大10像素
   │ 🌫️模糊半径: 5.0                │ ← 模糊边缘
   │ ... (其他参数)                  │
   └─────────────────────────────────┘
   
   结果: 遮罩扩大10像素，边缘模糊5像素

3. 关闭预处理
   ┌─────────────────────────────────┐
   │ 🎨启用遮罩预处理: false         │ ← 关闭
   │ 📏扩展: 10                      │ ← 无效
   │ 🌫️模糊半径: 5.0                │ ← 无效
   │ ... (其他参数)                  │
   └─────────────────────────────────┘
   
   结果: 所有预处理参数都被忽略

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 常用配置方案
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

方案1: 扩大并柔化边缘
  🎨启用遮罩预处理: true
  📏扩展: 10
  🔲倒角: true
  🌫️模糊半径: 5.0
  
  效果: 遮罩扩大，边缘圆滑且模糊
  用途: 创建柔和的选区，适合合成

方案2: 收缩并锐化
  🎨启用遮罩预处理: true
  📏扩展: -5
  🔲倒角: false
  
  效果: 遮罩收缩，边缘锐利
  用途: 去除边缘噪点，精确选区

方案3: 填补孔洞并模糊
  🎨启用遮罩预处理: true
  🔳填补: true
  🌫️模糊半径: 3.0
  
  效果: 填补内部孔洞，边缘柔和
  用途: 修复不完整的分割

方案4: 创建羽化效果
  🎨启用遮罩预处理: true
  🌫️模糊半径: 10.0
  💫线性透明: 0.7
  
  效果: 强烈模糊，保留部分原始特征
  用途: 创建自然的过渡效果

方案5: 边缘渐变
  🎨启用遮罩预处理: true
  🎚️腐蚀系数: 0.5
  🌫️模糊半径: 5.0
  
  效果: 从中心到边缘渐变，边缘模糊
  用途: 创建软边缘效果

方案6: 反向选区
  🎨启用遮罩预处理: true
  🔄反转输入: true
  
  效果: 前景变背景，背景变前景
  用途: 快速获得相反的选区

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💡 使用技巧
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 先关闭预处理，查看原始结果
   确认分割效果后，再开启预处理

2. 一次调整一个参数
   便于观察每个参数的效果

3. 扩展和模糊配合使用
   先扩展，再模糊，效果更自然

4. 使用线性透明微调
   如果效果太强，降低线性透明值

5. 保存常用配置
   记录好用的参数组合，方便复用

6. 预览遮罩图像输出
   实时查看预处理效果

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚙️ 技术细节
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

处理顺序:
  1. 反转输入（如果启用）
  2. 填补孔洞（如果启用）
  3. 扩展/腐蚀
  4. 应用腐蚀系数
  5. 高斯模糊
  6. 线性插值混合

依赖库:
  • OpenCV (cv2) - 用于形态学操作和模糊
  • SciPy - 用于填补孔洞和距离变换
  • NumPy - 用于数组操作

性能:
  • 预处理会增加少量处理时间（通常<0.1秒）
  • 关闭预处理时，性能无影响
  • 所有操作都在CPU上进行

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❓ 常见问题
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Q: 为什么我调整了参数，但遮罩没有变化？
A: 检查"🎨启用遮罩预处理"是否开启。
   只有开启后，其他参数才会生效。

Q: 扩展参数设置多少合适？
A: 取决于图像分辨率：
   • 小图 (512px): 5-10像素
   • 中图 (1024px): 10-20像素
   • 大图 (2048px): 20-40像素

Q: 模糊半径设置多少合适？
A: 通常是扩展值的一半：
   • 扩展10 → 模糊5
   • 扩展20 → 模糊10

Q: 可以同时使用多个预处理效果吗？
A: 可以！所有参数都可以组合使用。
   按照处理顺序依次应用。

Q: 预处理会影响性能吗？
A: 影响很小，通常增加<0.1秒。
   如果不需要，关闭即可。

Q: 预处理会降低遮罩质量吗？
A: 不会。预处理是为了改善遮罩，
   如果效果不好，关闭即可恢复原始遮罩。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎓 学习建议
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

初学者:
  1. 先使用默认设置（预处理关闭）
  2. 熟悉基本分割效果
  3. 尝试开启预处理，只调整扩展和模糊
  4. 观察效果，理解参数作用

进阶用户:
  1. 尝试不同的参数组合
  2. 记录好用的配置
  3. 针对不同场景使用不同配置
  4. 探索高级参数（腐蚀系数、线性透明）

专业用户:
  1. 理解每个参数的数学原理
  2. 创建自定义配置库
  3. 结合其他ComfyUI节点使用
  4. 优化工作流程

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 总结
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

主要特点:
  ✅ 灵活的遮罩处理
  ✅ 9个可调参数
  ✅ 主开关控制
  ✅ 参考KJNodes实现
  ✅ 无性能影响（关闭时）

主要用途:
  • 扩大/缩小遮罩
  • 柔化边缘
  • 填补孔洞
  • 创建羽化效果
  • 反转选区

使用建议:
  • 默认关闭，按需开启
  • 从简单参数开始
  • 观察效果，逐步调整
  • 保存常用配置

记住:
  遮罩预处理是可选功能，
  不需要时关闭即可！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
